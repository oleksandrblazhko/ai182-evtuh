## Тестування впровадження шаблону на стороні сервера
| ID |
|---|
| WSTG-INPV-18 |

### Короткі відомості
Веб-додатки зазвичай використовують серверні технології шаблонів (Jinja2, Twig, FreeMaker тощо) для створення динамічних відповідей HTML. Уразливості впровадження шаблонів на стороні сервера (SSTI) виникають, коли введені користувачем дані вбудовані в шаблон небезпечним чином і призводять до віддаленого виконання коду на сервері. Будь-які функції, які підтримують розширену розмітку, надану користувачем, можуть бути вразливими до SSTI, включаючи вікі-сторінки, огляди, маркетингові додатки, системи CMS тощо. Деякі механізми шаблонів використовують різні механізми (наприклад, пісочниця, дозвіл списку тощо) для захисту від SSTI.

#### Приклад - Twig
Наступний приклад є уривком із проекту Extreme Vulnerable Web Application.

```
public function getFilter($name)
{
        [snip]
        foreach ($this->filterCallbacks as $callback) {
        if (false !== $filter = call_user_func($callback, $name)) {
            return $filter;
        }
    }
    return false;
}
```

У функції getFilter функція `call_user_func($callback, $name)` вразлива до SSTI: параметр `name` отримується із запиту HTTP GET і виконується сервером.

#### Приклад - Flask/Jinja2
У наведеному нижче прикладі використовується механізм шаблонів Flask і Jinja2. Функція `page` приймає параметр «ім’я» із HTTP-запиту GET і відображає HTML-відповідь із вмістом змінної `name`:

```
@app.route("/page")
def page():
    name = request.values.get('name')
    output = Jinja2.from_string('Hello ' + name + '!').render()
    return output
```

Цей фрагмент коду вразливий до XSS, але він також уразливий до SSTI. Використання наступного як корисного навантаження в параметрі `name`:

```
$ curl -g 'http://www.target.com/page?name={{7*7}}'
Hello 49!
```

### Цілі тесту
- Виявити точки вразливості впровадження шаблону.
- Визначити механізм створення шаблонів.
- Створити експлойт.

### Як тестувати
Уразливості SSTI існують або в тексті, або в контексті коду. У контексті відкритого тексту користувачам дозволено використовувати «текст» довільної форми з прямим кодом HTML. У контексті коду дані користувача також можуть бути розміщені в операторі шаблону (наприклад, в назві змінної)

#### Визначте вразливість ін’єкції шаблону
Першим кроком у тестуванні SSTI у контексті відкритого тексту є створення загальних шаблонних виразів, які використовуються різними механізмами шаблонів як корисне навантаження, і моніторинг відповідей сервера, щоб визначити, який шаблонний вираз був виконаний сервером.

Приклади поширених шаблонних виразів:

```
a{{bar}}b
a{{7*7}}
{var} ${var} {{var}} <%var%> [% var %]
```

На цьому кроці рекомендується розширений список тестових рядків/корисних навантажень виразу шаблону.

Тестування SSTI в контексті коду дещо відрізняється. Спочатку тестувальник створює запит, який призводить до пустих або помилкових відповідей сервера. У наведеному нижче прикладі параметр HTTP GET вставляє інформацію про змінну `personal_greeting` у оператор шаблону:

```
personal_greeting=username
Hello user01
```

Використовуючи таке корисне навантаження - відповідь сервера є порожнє «Hello»:

```
personal_greeting=username<tag>
Hello
```


Наступним кроком є вихід із оператора шаблону та введення HTML-тегу після нього за допомогою наступного корисного навантаження:

```
personal_greeting=username}}<tag>
Hello user01 <tag>
```

#### Визначте механізм створення шаблонів
На основі інформації з попереднього кроку тепер тестувальник має визначити, який механізм шаблонів використовується, надаючи різні вирази шаблону. На основі відповідей сервера тестувальник визначає механізм використання шаблонів. Цей ручний підхід більш детально описано в цій статті PortSwigger. Для автоматизації ідентифікації вразливості SSTI та механізму створення шаблонів доступні різні інструменти, включаючи Tplmap або розширення Backslash Powered Scanner Burp Suite.

#### Створіть RCE Exploit
Основна мета цього кроку — визначити подальший контроль над сервером за допомогою експлойту RCE шляхом вивчення документації шаблону та дослідження. Ключові сфери інтересів:

- Розділи для авторів шаблонів, що охоплюють базовий синтаксис.
- Розділи щодо безпеки.
- Списки вбудованих методів, функцій, фільтрів і змінних.
- Списки розширень/плагінів.

Тестер також може визначити, які інші об’єкти, методи та властивості можна відкрити, зосередившись на `self` об’єкті. Якщо об’єкт `self` недоступний і документація не розкриває технічні деталі, рекомендується груба сила імені змінної. Після ідентифікації об’єкта наступним кроком є ​​проходження об’єкта, щоб ідентифікувати всі методи, властивості та атрибути, які доступні через систему шаблонів. Це може призвести до інших типів виявлень безпеки, зокрема підвищення привілеїв, розкриття інформації про паролі програм, ключі API, конфігурації та змінні середовища тощо.
